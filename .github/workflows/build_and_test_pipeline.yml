# .github/workflows/ci.yml

name: Build and Test

on:
  push:
    branches: [ "main", "Task/*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_and_test: # Changed job name to be more descriptive
    name: Build and Test on iOS Simulator
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        # Using Xcode 15.4 as a stable example. You can change this back to 16.1 if needed.
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      - name: Build library for testing
        # We use -scheme instead of -project for SPM libraries.
        # The scheme name typically matches your package name.
        # 'clean' is omitted for speed as CI environments are already clean.
        run: |
          xcodebuild build \
            -scheme RecordingService \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            CODE_SIGNING_ALLOWED=NO

      - name: Run library tests
        # We again use -scheme to target the tests for your library.
        # Adding -enableCodeCoverage is a CI best practice.
        run: |
          xcodebuild test \
            -scheme RecordingService \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -enableCodeCoverage YES \
            CODE_SIGNING_ALLOWED=NO

      - name: Notify Telegram on Status
        # This step runs regardless of whether the build/test succeeded or failed.
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="‚úÖ Build Succeeded"
          else
            STATUS="‚ùå Build Failed"
          fi
          
          # Create a URL-encoded message for the Telegram API
          MESSAGE="${STATUS}%0A%0Aüì¶ *Repo:* ${{ github.repository }}%0Aüåø *Branch:* ${{ github.ref_name }}%0A%0Aüîó [View Build Log](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          # Send the message using curl
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}"
